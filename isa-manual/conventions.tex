% -*- mode: latex; tab-width: 2; indent-tabs-mode: nil; -*-
%------------------------------------------------------------------------------
% MRISC32 ISA Manual - Conventions.
%
% This work is licensed under the Creative Commons Attribution-ShareAlike 4.0
% International License. To view a copy of this license, visit
% http://creativecommons.org/licenses/by-sa/4.0/ or send a letter to
% Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.
%------------------------------------------------------------------------------

\chapter{Conventions}

\section{Instruction aliases}

This section defines valid assembler aliases for common operations that are
implemented using more generic instructions.

It is recommended that instruction aliases are used in place of their generic
counterparts in most situations, such as assembler code generated by a compiler
or a disassembler.

The main purposes of the instruction aliases are to improve the readability of
assembler programs and listings, and to make it easier to write assembler
programs.

\subsection{ASR - Arithmetic shift right}
\label{insn:ASR}

Shift signed integer to the right.

Syntax:
\begin{lstlisting}[style=assembler]
  asr  ra, rb, #shift  ; Immediate
  asr  ra, rb, rc      ; Register
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  ebf  ra, rb, #<shift:0>  ; Immediate
  ebf  ra, rb, rc          ; Register
\end{lstlisting}

\subsection{B - Branch}
\label{insn:B}

Unconditionally branch to a PC-relative target.

Syntax:
\begin{lstlisting}[style=assembler]
  b  #target
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  j  pc, #target@pc
\end{lstlisting}

\begin{notebox}
The branch range for the B alias is PC +/-4MiB.

This alias is preferred to alternatives based on conditional branch
instructions with known conditions (such as using BZ with the Z register as the
condition).
\end{notebox}

\subsection{BL - Branch and link}
\label{insn:BL}

Unconditionally branch and link to a PC-relative target.

Syntax:
\begin{lstlisting}[style=assembler]
  bl  #target
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  jl  pc, #target@pc
\end{lstlisting}

\begin{notebox}
The branch range for the BL alias is PC +/-4MiB.
\end{notebox}

\subsection{CALL - Call a subroutine}
\label{insn:CALL}

Call a subroutine, with full 32-bit address range.

Syntax:
\begin{lstlisting}[style=assembler]
  call  #target@pc  ; PC-relative
  call  #target     ; Absolute
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  ; PC-relative
  addpchi  lr, #target@pchi
  jl       lr, #target+4@pclo

  ; Absolute
  ldi      lr, #target@hi
  jl       lr, #target@lo
\end{lstlisting}

\subsection{GETSR - Get system register}
\label{insn:GETSR}

Move the value of a system register to a general purpose register.

Syntax:
\begin{lstlisting}[style=assembler]
  getsr  ra, #sr_reg_no  ; Immediate
  getsr  ra, rc          ; Register
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  xchgsr  ra, z, #sr_reg_no  ; Immediate
  xchgsr  ra, z, rc          ; Register
\end{lstlisting}

\subsection{LSL - Logic shift left}
\label{insn:LSL}

Shift integer to the left.

Syntax:
\begin{lstlisting}[style=assembler]
  lsl  ra, rb, #shift  ; Immediate
  lsl  ra, rb, rc      ; Register
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  mkbf  ra, rb, #<shift:0>  ; Immediate
  mkbf  ra, rb, rc          ; Register
\end{lstlisting}

\subsection{LSR - Logic shift right}
\label{insn:LSR}

Shift unsigned integer to the right.

Syntax:
\begin{lstlisting}[style=assembler]
  lsr  ra, rb, #shift  ; Immediate
  lsr  ra, rb, rc      ; Register
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  ebfu  ra, rb, #<shift:0>  ; Immediate
  ebfu  ra, rb, rc          ; Register
\end{lstlisting}

\subsection{MOV - Move}
\label{insn:MOV}

Move value to register.

Syntax:
\begin{lstlisting}[style=assembler]
  mov  ra, #value  ; Immediate
  mov  ra, rb      ; Register
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  or  ra, (v)z, #value  ; Immediate
  or  ra, (v)z, rb      ; Register
\end{lstlisting}

\begin{notebox}
The immediate form of the MOV alias is mostly useful for vector target
registers. For scalar targer registers the \hyperref[insn:LDI]{LDI} instruction
is more suitable since it has a wider immediate range.
\end{notebox}

\subsection{NOP - No operation}
\label{insn:NOP}

Perform no operation.

Syntax:
\begin{lstlisting}[style=assembler]
  nop
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  or  z, z, z
\end{lstlisting}

\subsection{RET - Return}
\label{insn:RET}

Retrun from a subroutine (jump to the address pointed to by LR).

Syntax:
\begin{lstlisting}[style=assembler]
  ret
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  j  lr, #0
\end{lstlisting}

\subsection{SETSR - Set system register}
\label{insn:SETSR}

Move the value of a general purpose register to a system register.

Syntax:
\begin{lstlisting}[style=assembler]
  setsr  rb, #sr_reg_no  ; Immediate
  setsr  rb, rc          ; Register
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  xchgsr  z, rb, #sr_reg_no  ; Immediate
  xchgsr  z, rb, rc          ; Register
\end{lstlisting}

\subsection{TAIL - Tail call}
\label{insn:TAIL}

Make a tail call to a sibling routine, with full 32-bit address range.

Syntax:
\begin{lstlisting}[style=assembler]
  tail  #target@pc  ; PC-relative
  tail  #target     ; Absolute
\end{lstlisting}

Expands to:
\begin{lstlisting}[style=assembler]
  ; PC-relative
  addpchi  r15, #target@pchi
  j        r15, #target+4@pclo

  ; Absolute
  ldi      r15, #target@hi
  j        r15, #target@lo
\end{lstlisting}

\begin{notebox}
The TAIL alias implicitly clobbers the R15 register. When using the TAIL alias
for making tail calls, this is well defined behavior since R15 is defined as an
intra-procedure call scratch register in the recommended calling convention.
\end{notebox}

\section{Canonical constructs}

Certain operations can be done in several ways with (more or less) equivalent
effect, but for the sake of hardware implementation efficiency this section
defines the preferred way for those operations.

\tbd
